!function(x){"undefined"==typeof Spoon&&(Spoon={}),Spoon.FieldManipulator=Garnish.Base.extend({_handleMatrixInputInitProxy:null,_handleMatrixInputBlockAddedProxy:null,init:function(t){this.setSettings(t,Spoon.FieldManipulator.defaults),"entrytype"===this.settings.context.split(":")[0]&&Garnish.on(Craft.EntryTypeSwitcher,"beforeTypeChange",x.proxy(function(t){this.settings.context="entrytype:"+t.target.$typeSelect.val()},this)),this._handleMatrixInputInitProxy=x.proxy(this,"handleMatrixInputInit"),this._handleMatrixInputBlockAddedProxy=x.proxy(this,"handleMatrixInputBlockAdded"),Garnish.on(Craft.MatrixInput,"afterInit",this._handleMatrixInputInitProxy),Garnish.on(Craft.MatrixInput,"blockAdded",this._handleMatrixInputBlockAddedProxy),void 0!==Craft.SuperTable&&(void 0!==Craft.SuperTable.Input?(Garnish.on(Craft.SuperTable.Input,"afterInit",this._handleMatrixInputInitProxy),Garnish.on(Craft.SuperTable.Input,"blockAdded",this._handleMatrixInputBlockAddedProxy)):void 0!==Craft.SuperTable.MatrixInputAlt&&(Garnish.on(Craft.SuperTable.MatrixInputAlt,"afterInit",this._handleMatrixInputInitProxy),Garnish.on(Craft.SuperTable.MatrixInputAlt,"blockAdded",this._handleMatrixInputBlockAddedProxy))),this.settings.versioned&&Garnish.$doc.find(".matrix-field").each(x.proxy(function(t,e){var n=x(e);this.initBlockTypeGroups(n),n.find("> .blocks > .matrixblock").each(x.proxy(function(t,e){this.initBlocks(x(e),n)},this))},this))},handleMatrixInputInit:function(t){var n=t.target.$container,e=t.target.$blockContainer.children();this.initBlockTypeGroups(n),e.each(x.proxy(function(t,e){this.initBlocks(x(e),n)},this))},handleMatrixInputBlockAdded:function(t){var e=t.target.$container,n=x(t.$block);this.initBlocks(n,e)},initBlockTypeGroups:function(t){if(!t.data("spooned")){var e=this._getMatrixFieldName(t),n=[];if(void 0!==this.settings.blockTypes[this.settings.context]&&(n=x.grep(this.settings.blockTypes[this.settings.context],function(t){return t.fieldHandle===e})),n.length<1&&void 0!==this.settings.blockTypes.global&&(n=x.grep(this.settings.blockTypes.global,function(t){return t.fieldHandle===e})),1<=n.length&&(t.data("spooned",!0),t.data("spoon-block-types",n),!this.settings.versioned)){var a=t.find("> .buttons").first();a.addClass("hidden");for(var i=x('<div class="buttons-spooned" />').insertAfter(a),d=x('<div class="btngroup" />').appendTo(i),s=x('<div class="btn add icon menubtn hidden">'+Craft.t("app","Add a block")+"</div>").appendTo(i),o=x('<div class="menu spoon-secondary-menu" />').appendTo(i),r=0;r<n.length;r++){if(0===d.find('[data-spooned-group="'+n[r].groupName+'"]').length){x('<div class="btn  menubtn">'+Craft.t("site",n[r].groupName)+"</div>").appendTo(d);var l=x('<div class="menu" data-spooned-group="'+n[r].groupName+'" />').appendTo(d),p=x("<ul />").appendTo(l);0!==r&&x("<hr>").appendTo(o),x("<h6>"+Craft.t("site",n[r].groupName)+"</h6>").appendTo(o);var h=x("<ul/>").appendTo(o)}$li=x('<li><a data-type="'+n[r].matrixBlockType.handle+'">'+Craft.t("site",n[r].matrixBlockType.name)+"</a></li>"),$li.appendTo(p),$li.clone().appendTo(h)}d.find(".menubtn").each(function(){new Garnish.MenuBtn(x(this),{onOptionSelect:function(t){var e=x(t).data("type");a.find('[data-type="'+e+'"]').trigger("click")}})}),new Garnish.MenuBtn(s,{onOptionSelect:function(t){var e=x(t).data("type");a.find('[data-type="'+e+'"]').trigger("click")}}),this.addListener(t,"resize",x.proxy(function(){(t.data("spoon-main-buttons-width")||(t.data("spoon-main-buttons-width",d.width()),t.data("spoon-main-buttons-width")))&&(t.width()<t.data("spoon-main-buttons-width")?(s.removeClass("hidden"),d.addClass("hidden")):(s.addClass("hidden"),d.removeClass("hidden")))},this))}}},initBlocks:function(t,e){if(t.data("spooned"))Garnish.$doc.trigger("scroll");else{t.data("spooned",!0);var n=e.data("spoon-block-types");if(void 0!==n&&1<=n.length){if(!this.settings.versioned){var a=t.find(".actions .settings.menubtn");this.initSettingsMenu(a,n,e)}var i=this._getMatrixBlockTypeHandle(t),d=x.grep(n,function(t){return t.matrixBlockType.handle===i});if(1===d.length&&null!==d[0].fieldLayoutId)t.data("spooned-block-type",d[0]),this.initBlockFieldLayout(t,e);else if(this.settings.blockTypes.hasOwnProperty("global")){var s=this._getMatrixFieldName(e);1<=(n=x.grep(this.settings.blockTypes.global,function(t){return t.fieldHandle===s})).length&&1===(d=x.grep(n,function(t){return t.matrixBlockType.handle===i})).length&&null!==d[0].fieldLayoutId?(t.data("spooned-block-type",d[0]),this.initBlockFieldLayout(t,e)):t.addClass("matrixblock-not-spooned")}else t.addClass("matrixblock-not-spooned")}else t.addClass("matrixblock-not-spooned")}},initBlockFieldLayout:function(t,e){var n=t.data("spooned-block-type"),a=n.fieldLayoutModel.tabs,i=n.fieldLayoutModel.fields;if(1<=a.length){t.addClass("matrixblock-spooned"),this.settings.versioned&&t.addClass("matrixblock-spooned--disabled");var d=e.prop("id")+"-blocks-"+t.data("id"),s="spoon-"+d,o=x('<ul class="spoon-tabs"/>').appendTo(t),r=x('<div class="spoon-fields"/>').css({opacity:0}).appendTo(t),l=t.find("> .fields");l.css({opacity:0}),r.addClass("fields");for(var p=0;p<a.length;p++){var h="",c="";if(0===p?h=" sel":c=" hidden",1<a.length)var u=x("<li/>").appendTo(o),f=x('<a id="'+s+"-"+p+'" class="tab'+h+'">'+Craft.t("site",a[p].name)+"</a>").appendTo(u).data("spooned-tab-target","#"+s+"-pane-"+p);for(var g=x('<div id="'+s+"-pane-"+p+'" class="'+c+'"/>').appendTo(r),y=x.grep(i,function(t){return t.tabId===a[p].id}),v=0;v<y.length;v++)l.find("#"+d+"-fields-"+y[v].handle+"-field").appendTo(g);0<g.find(".field.has-errors").length&&1<a.length&&(f.addClass("error"),f.append(' <span data-icon="alert" />'))}1<a.length&&this.addListener(o.find("a"),"click","onTabClick"),l.hide(),r.velocity({opacity:1},"fast",x.proxy(function(){Craft.initUiElements(r)},this))}},onTabClick:function(t){t.preventDefault(),t.stopPropagation();var e=x(t.target),n=e.parent().parent(".spoon-tabs"),a=e.data("spooned-tab-target"),i=x(a);n.find("a.sel").removeClass("sel"),e.addClass("sel"),i.siblings("div").addClass("hidden"),i.removeClass("hidden")},initSettingsMenu:function(l,p,h){Garnish.requestAnimationFrame(x.proxy(function(){var t=l.data("menubtn")||!1;if(t){var e=this._getMatrixFieldName(h),n=t.menu.$container;n.addClass("spoon-settings-menu"),n.find('a[data-action="add"]').parents("li").addClass("hidden"),n.find("hr").removeClass("padded");for(var a=n.find('a[data-action="add"]').parents("li").parent("ul"),i=0;i<p.length;i++){var d=p[i].matrixBlockType.handle;if(0===n.find('[data-spooned-group="'+p[i].groupName+'"]').length)if(x.grep(this.settings.nestedSettingsHandles,function(t){return t===e}).length){var s=x('<ul class="padded hidden" data-spooned-group="'+p[i].groupName+'" />');0!==i&&x("<hr/>").insertBefore(a);var o=x('<a class="fieldtoggle">'+Craft.t("site",p[i].groupName)+"</a>");o.insertBefore(a),s.insertBefore(a),this.addListener(o,"click",function(t){var e=x(t.currentTarget),n=e.next("ul");n.hasClass("hidden")?(n.removeClass("hidden"),e.addClass("expanded")):(n.addClass("hidden"),e.removeClass("expanded"))})}else{s=x('<ul class="padded" data-spooned-group="'+p[i].groupName+'" />');0!==i&&x("<hr/>").insertBefore(a),x("<h6>"+Craft.t("site",p[i].groupName)+"</h6>").insertBefore(a),s.insertBefore(a)}var r=n.find('a[data-type="'+d+'"]').parents("li");s.append(r),r.removeClass("hidden")}}else this.initSettingsMenu(l,p,h)},this))},_getMatrixFieldName:function(t){var e=t.parentsUntil(".field").parent().prop("id").split("-");if(9===e.length)var n=e[e.length-8]+"-"+e[e.length-5]+"-"+e[e.length-2];else if(6===e.length)n=e[e.length-5]+"-"+e[e.length-2];else if(3===e.length)n=e[e.length-2];return""!==n&&n},_getMatrixBlockTypeHandle:function(t){var e=t.data("type");return"string"==typeof e&&e}},{defaults:{blockTypes:null,context:!1,versioned:!1,nestedSettingsHandles:[]}})}(jQuery);