!function(m){"undefined"==typeof Spoon&&(Spoon={}),Spoon.FieldManipulator=Garnish.Base.extend({_handleMatrixInputInitProxy:null,_handleMatrixInputBlockAddedProxy:null,init:function(t){this.setSettings(t,Spoon.FieldManipulator.defaults),"entrytype"===this.settings.context.split(":")[0]&&Garnish.on(Craft.EntryTypeSwitcher,"beforeTypeChange",m.proxy(function(t){this.settings.context="entrytype:"+t.target.$typeSelect.val()},this)),this._handleMatrixInputInitProxy=m.proxy(this,"handleMatrixInputInit"),this._handleMatrixInputBlockAddedProxy=m.proxy(this,"handleMatrixInputBlockAdded"),Garnish.on(Craft.MatrixInput,"afterInit",this._handleMatrixInputInitProxy),Garnish.on(Craft.MatrixInput,"blockAdded",this._handleMatrixInputBlockAddedProxy)},handleMatrixInputInit:function(t){console.log("m init");var n=t.target.$container,e=t.target.$blockContainer.children();this.initBlockTypeGroups(n),e.each(m.proxy(function(t,e){this.initBlocks(m(e),n)},this))},handleMatrixInputBlockAdded:function(t){var e=t.target.$container,n=m(t.data.block);this.initBlocks(n,e)},initBlockTypeGroups:function(t){if(!t.data("spooned")){var e=this._getMatrixFieldName(t),n=[];if(void 0!==this.settings.blockTypes[this.settings.context]&&(n=m.grep(this.settings.blockTypes[this.settings.context],function(t){return t.fieldHandle===e})),n.length<1&&void 0!==this.settings.blockTypes.global&&(n=m.grep(this.settings.blockTypes.global,function(t){return t.fieldHandle===e})),1<=n.length){t.data("spooned",!0),t.data("spoon-block-types",n);var a=t.find("> .buttons").first();a.addClass("hidden");for(var i=m('<div class="buttons-spooned" />').insertAfter(a),d=m('<div class="btngroup" />').appendTo(i),o=m('<div class="btn add icon menubtn hidden">'+Craft.t("app","Add a block")+"</div>").appendTo(i),s=m('<div class="menu spoon-secondary-menu" />').appendTo(i),l=0;l<n.length;l++){if(0===d.find('[data-spooned-group="'+n[l].groupName+'"]').length){m('<div class="btn  menubtn">'+Craft.t("site",n[l].groupName)+"</div>").appendTo(d);var r=m('<div class="menu" data-spooned-group="'+n[l].groupName+'" />').appendTo(d),p=m("<ul />").appendTo(r);0!==l&&m("<hr>").appendTo(s),m("<h6>"+Craft.t("site",n[l].groupName)+"</h6>").appendTo(s);var h=m("<ul/>").appendTo(s)}$li=m('<li><a data-type="'+n[l].matrixBlockType.handle+'">'+Craft.t("site",n[l].matrixBlockType.name)+"</a></li>"),$li.appendTo(p),$li.clone().appendTo(h)}d.find(".menubtn").each(function(){new Garnish.MenuBtn(m(this),{onOptionSelect:function(t){var e=m(t).data("type");a.find('[data-type="'+e+'"]').trigger("click")}})}),new Garnish.MenuBtn(o,{onOptionSelect:function(t){var e=m(t).data("type");a.find('[data-type="'+e+'"]').trigger("click")}}),this.addListener(t,"resize",m.proxy(function(){(t.data("spoon-main-buttons-width")||(t.data("spoon-main-buttons-width",d.width()),t.data("spoon-main-buttons-width")))&&(t.width()<t.data("spoon-main-buttons-width")?(o.removeClass("hidden"),d.addClass("hidden")):(o.addClass("hidden"),d.removeClass("hidden")))},this))}}},initBlocks:function(t,e){if(t.data("spooned"))Garnish.$doc.trigger("scroll");else{t.data("spooned",!0);var n=e.data("spoon-block-types");if(void 0!==n&&1<=n.length){var a=t.find(".actions .settings.menubtn");this.initSettingsMenu(a,n,e);var i=this._getMatrixBlockTypeHandle(t),d=m.grep(n,function(t){return t.matrixBlockType.handle===i});if(1===d.length&&null!==d[0].fieldLayoutId)t.data("spooned-block-type",d[0]),this.initBlockFieldLayout(t,e);else if(this.settings.blockTypes.hasOwnProperty("global")){var o=this._getMatrixFieldName(e);1<=(n=m.grep(this.settings.blockTypes.global,function(t){return t.fieldHandle===o})).length&&1===(d=m.grep(n,function(t){return t.matrixBlockType.handle===i})).length&&null!==d[0].fieldLayoutId?(t.data("spooned-block-type",d[0]),this.initBlockFieldLayout(t,e)):t.addClass("matrixblock-not-spooned")}else t.addClass("matrixblock-not-spooned")}else t.addClass("matrixblock-not-spooned")}},initBlockFieldLayout:function(t,e){var n=t.data("spooned-block-type"),a=n.fieldLayoutModel.tabs,i=n.fieldLayoutModel.fields;if(1<=a.length){t.addClass("matrixblock-spooned");var d=e.prop("id")+"-"+t.data("id"),o="spoon-"+d,s=m('<ul class="spoon-tabs"/>').appendTo(t),l=m('<div class="spoon-fields"/>').css({opacity:0}).appendTo(t),r=t.find("> .fields");r.css({opacity:0});for(var p=0;p<a.length;p++){var h="",c="";if(0==p?h=" sel":c=" hidden",1<a.length)var u=m("<li/>").appendTo(s),f=m('<a id="'+o+"-"+p+'" class="tab'+h+'">'+Craft.t("site",a[p].name)+"</a>").appendTo(u).data("spooned-tab-target","#"+o+"-pane-"+p);for(var g=m('<div id="'+o+"-pane-"+p+'" class="'+c+'"/>').appendTo(l),y=m.grep(i,function(t){return t.tabId===a[p].id}),v=0;v<y.length;v++)r.find("#"+d+"-fields-"+y[v].handle+"-field").appendTo(g);0<g.find(".field.has-errors").length&&(f.addClass("error"),f.append(' <span data-icon="alert" />'))}1<a.length&&this.addListener(s.find("a"),"click","onTabClick"),r.hide(),l.velocity({opacity:1},"fast",m.proxy(function(){Craft.initUiElements(l)},this))}},onTabClick:function(t){t.preventDefault(),t.stopPropagation();var e=m(t.target),n=e.parent().parent(".spoon-tabs"),a=e.data("spooned-tab-target"),i=m(a);n.find("a.sel").removeClass("sel"),e.addClass("sel"),i.siblings("div").addClass("hidden"),i.removeClass("hidden")},initSettingsMenu:function(r,p,h){Garnish.requestAnimationFrame(m.proxy(function(){var t=r.data("menubtn")||!1;if(t){var e=this._getMatrixFieldName(h),n=t.menu.$container;n.addClass("spoon-settings-menu"),n.find('a[data-action="add"]').parents("li").addClass("hidden"),n.find("hr").removeClass("padded");for(var a=n.find('a[data-action="add"]').parents("li").parent("ul"),i=0;i<p.length;i++){var d=p[i].matrixBlockType.handle;if(0===n.find('[data-spooned-group="'+p[i].groupName+'"]').length)if(m.grep(this.settings.nestedSettingsHandles,function(t){return t===e}).length){var o=m('<ul class="padded hidden" data-spooned-group="'+p[i].groupName+'" />');0!==i&&m("<hr/>").insertBefore(a);var s=m('<a class="fieldtoggle">'+Craft.t("site",p[i].groupName)+"</a>");s.insertBefore(a),o.insertBefore(a),this.addListener(s,"click",function(t){var e=m(t.currentTarget),n=e.next("ul");n.hasClass("hidden")?(n.removeClass("hidden"),e.addClass("expanded")):(n.addClass("hidden"),e.removeClass("expanded"))})}else{o=m('<ul class="padded" data-spooned-group="'+p[i].groupName+'" />');0!==i&&m("<hr/>").insertBefore(a),m("<h6>"+Craft.t("site",p[i].groupName)+"</h6>").insertBefore(a),o.insertBefore(a)}var l=n.find('a[data-type="'+d+'"]').parents("li");o.append(l),l.removeClass("hidden")}}else this.initSettingsMenu(r,p,h)},this))},_getMatrixFieldName:function(t){var e=t.parentsUntil(".field").parent().prop("id").split("-");if(9===e.length)var n=e[e.length-8]+"-"+e[e.length-5]+"-"+e[e.length-2];else if(6===e.length)n=e[e.length-5]+"-"+e[e.length-2];else if(3===e.length)n=e[e.length-2];return""!=n&&n},_getMatrixBlockTypeHandle:function(t){var e=t.find('> input[type="hidden"][name*="type"]').val();return"string"==typeof e&&e}},{defaults:{blockTypes:null,context:!1,nestedSettingsHandles:[]}})}(jQuery);